---
import { TESTIMONIALS } from '@/consts/testimonials';
import Icon from '@/components/Icon.astro';
---

<section {...Astro.props}>
  <div class="flow-16 mx-auto max-w-7xl px-4 py-20 sm:px-6 lg:px-8">
    <div class="grid justify-items-center gap-4 text-center">
      <h2 class="text-3xl font-bold text-gray-900 md:text-4xl">
        Lo que dicen nuestros clientes
      </h2>
      <p class="max-w-3xl text-xl text-gray-600">
        La satisfacción de nuestros clientes es nuestra mayor recompensa. Aquí
        puedes leer sus experiencias y comentarios reales.
      </p>
    </div>

    <div id="testimonials-carousel" class="embla mask-x-from-95%">
      <ul class="embla__container py-1">
        {
          TESTIMONIALS.map(testimonial => (
            <li class="embla__slide">
              <div class="flow rounded-xl border border-gray-100 bg-gradient-to-br from-white to-gray-50 p-6 shadow-md">
                <div class="flex items-center gap-4">
                  <img
                    src={testimonial.avatar}
                    alt={testimonial.name}
                    class="size-12 rounded-full object-cover object-center"
                  />
                  <div>
                    <h4 class="font-semibold text-gray-900">
                      {testimonial.name}
                    </h4>
                    <p class="text-sm text-gray-600">{testimonial.service}</p>
                  </div>
                </div>
                <div class="flex items-center">
                  {[...Array(testimonial.rating)].map(_ => (
                    <Icon name="star-filled" class="size-5 text-yellow-400" />
                  ))}
                </div>
                <div class="relative">
                  <Icon
                    name="quote"
                    class="absolute -top-2 -left-2 size-8 text-blue-200"
                  />
                  <p class="pl-6 leading-relaxed text-gray-700">
                    {testimonial.comment}
                  </p>
                </div>
              </div>
            </li>
          ))
        }
      </ul>
    </div>

    <div
      class="flow rounded-2xl bg-gradient-to-r from-green-500 to-blue-600 p-8 text-center text-white"
    >
      <h3 class="text-2xl font-bold">
        ¿Quedaste satisfecho con nuestro servicio?
      </h3>
      <p>
        Ayúdanos a seguir mejorando dejando tu comentario y compartiendo tu
        experiencia con otros clientes.
      </p>
      <ul
        class="grid gap-4 bg-gradient-to-r from-green-500 to-blue-600 md:grid-cols-2"
      >
        <li>
          <a
            href="https://instagram.com/techrepairpro"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center justify-center gap-2 rounded-lg border-2 border-white bg-transparent px-6 py-3 font-semibold text-white transition-colors hover:bg-white hover:text-purple-500"
          >
            <Icon name="instagram" class="shrink-0" />
            Seguinos en Instagram
          </a>
        </li>
        <li>
          <a
            href="https://wa.me/1234567890"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center justify-center gap-2 rounded-lg border-2 border-white bg-transparent px-6 py-3 font-semibold text-white transition-colors hover:bg-white hover:text-green-500"
          >
            <Icon name="whatsapp" class="shrink-0" />
            Dejá tu comentario
          </a>
        </li>
      </ul>
    </div>
  </div>
</section>

<script>
  import EmblaCarousel from 'embla-carousel';
  import Autoscroll from 'embla-carousel-auto-scroll';
  import type { EmblaOptionsType, EmblaPluginType } from 'embla-carousel';

  const $emblaNode = document.querySelector(
    '#testimonials-carousel'
  ) as HTMLElement;
  const options: EmblaOptionsType = {
    loop: true,
    align: 'start',
  };

  const plugins: EmblaPluginType[] = [
    Autoscroll({
      speed: 0.75,
      stopOnInteraction: false,
      stopOnFocusIn: false,
      stopOnMouseEnter: true,
      startDelay: 0,
      playOnInit: false,
    }),
  ];

  if ($emblaNode) {
    const emblaApi = EmblaCarousel($emblaNode, options, plugins);

    const observer = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach(entry => {
          const isIntersecting = entry.isIntersecting;
          isIntersecting
            ? emblaApi.plugins().autoScroll.play()
            : emblaApi.plugins().autoScroll.stop();
        });
      },
      {
        root: null,
        rootMargin: '0px',
        threshold: 0,
      }
    );
    observer.observe($emblaNode);
  }
</script>

<style>
  .embla {
    overflow: hidden;
  }

  .embla__container {
    --slides-per-view: 1;
    --gap: 1rem;
    --rest: calc(calc(var(--slides-per-view) - 1) * var(--gap));
    --available-space: calc(100% - var(--rest));
    display: flex;

    @media (width >= 30rem) {
      --slides-per-view: 2;
    }

    @media (width >= 64rem) {
      --slides-per-view: 4;
    }
  }
  .embla__slide {
    flex: 0 0 calc(var(--available-space) / var(--slides-per-view));
    margin-right: var(--gap);
    min-width: 0;

    > * {
      height: 100%;
    }
  }
</style>
